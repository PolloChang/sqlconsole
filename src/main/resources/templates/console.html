<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title>Java Master SQL Console</title>
    <script src="/js/jquery-3.7.1.min.js"></script>
    <meta charset="UTF-8">
    <script type="module" src="/js/editor.bundle.js"></script>
    <style>
        .cm-editor { border: 1px solid #ccc; height: 300px; font-size: 14px; background-color: white;}
        .cm-scroller { overflow: auto; }
    </style>
</head>
<body>
<h1>SQL åŸ·è¡Œæ§åˆ¶å°</h1>
<div>
    ç™»å…¥è€…: <span th:text="${username}"></span>
    è§’è‰²: <span th:text="${role}"></span>
    ç‹€æ…‹: <span id="txStatus" style="font-weight:bold; color:blue;">COMMITTED</span>
    <span style="margin: 0 10px;" th:if="${role == 'ROLE_AUDITOR'}">|</span>
    <a href="/connections" th:if="${role == 'ROLE_AUDITOR'}">é€£ç·šç®¡ç†</a>
    <span style="margin: 0 10px;" sec:authorize="hasRole('ADMIN')">|</span>
    <a href="/admin/users" sec:authorize="hasRole('ADMIN')">ä½¿ç”¨è€…ç®¡ç†</a>
    <span style="margin: 0 10px;">|</span>
    <a href="/logout">ç™»å‡º</a>
</div>
<hr/>

<div th:if="${role == 'ROLE_AUDITOR'}">
    <h3>å¾…å¯©æ ¸å·¥å–®</h3>
    <table border="1">
        <tr><th>ID</th><th>ç”³è«‹äºº</th><th>SQL</th><th>å‹•ä½œ</th></tr>
        <tr th:each="task : ${tasks}">
            <td th:text="${task.id}"></td>
            <td th:text="${task.requester}"></td>
            <td th:text="${task.sqlContent}"></td>
            <td><button th:onclick="'approveTask(' + ${task.id} + ')'">æ‰¹å‡†ä¸¦åŸ·è¡Œ</button></td>
        </tr>
    </table>
    <hr/>
</div>

<h3>SQL æ“ä½œ</h3>
<form id="sqlForm" onsubmit="return false;">
    é¸æ“‡è³‡æ–™åº«:
    <select id="dbId" onchange="loadTables()">
        <option th:each="db : ${dbs}" th:value="${db.id}" th:text="${db.name}"></option>
    </select>
    <br/><br/>
    <div id="editor"></div>
    <br/>
    <button onclick="doSql('EXEC')">åŸ·è¡Œ SQL</button>
    <button onclick="doSql('COMMIT')">COMMIT</button>
    <button onclick="doSql('ROLLBACK')">ROLLBACK</button>
</form>

<fieldset style="margin-top: 20px; border: 1px solid #ccc; padding: 10px;">
    <legend>ğŸ¦ Virtual DBA</legend>
    <button id="btn-analyze" onclick="doAnalyze()">Analyze SQL Performance</button>

    <div id="dba-loading" style="display:none; color: blue; margin-top: 10px;">
        ğŸ¦ Analyzing SQL performance...
    </div>

    <div id="dba-error" style="display:none; color: red; margin-top: 10px; font-weight: bold;"></div>

    <div id="dba-report-area" style="margin-top: 10px; display: none;">
        <div id="dba-metrics"></div>

        <h4>Suggestions</h4>
        <ul id="dba-suggestions" style="color: #d9534f;"></ul>

        <h4>Execution Plan</h4>
        <div style="position: relative;">
            <button onclick="copyPlan()" style="position: absolute; right: 5px; top: 5px; padding: 2px 5px;">Copy</button>
            <pre id="dba-plan" style="background: #f5f5f5; padding: 30px 10px 10px 10px; overflow-x: auto; min-height: 50px;"></pre>
        </div>
    </div>
</fieldset>

<h3>çµæœ</h3>
<div id="msgArea"></div>
<div id="resultTable"></div>


<script>
    $(document).ready(function() {
        // Load tables for the initial selection
        loadTables();
    });

    function loadTables() {
        let dbId = $("#dbId").val();
        if (!dbId) return;

        $.get("/api/schema", { dbId: dbId }, function(schema) {
             if (window.updateEditorSchema) {
                 window.updateEditorSchema(schema);
             }
        });
    }

    function doSql(action) {
        let sql = "";
        if (action === 'EXEC') {
            if (window.getSmartSql) {
                sql = window.getSmartSql();
            }
        } else {
            sql = action;
        }
        let dbId = $("#dbId").val();

        $.post("/api/execute", { dbId: dbId, sql: sql }, function(res) {
            renderResult(res);
        });
    }

    function doAnalyze() {
        let sql = "";
        if (window.getSmartSql) {
            sql = window.getSmartSql();
        } else if ($("#sql").length) {
            sql = $("#sql").val();
        }

        let dbId = $("#dbId").val();

        // Reset UI
        $("#dba-loading").show();
        $("#dba-report-area").hide();
        $("#dba-error").hide();

        $.ajax({
            url: "/api/sql/analyze",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({ dbId: parseInt(dbId), sql: sql }),
            success: function(report) {
                 $("#dba-loading").hide();
                 $("#dba-report-area").show();

                 // Suggestions
                 $("#dba-suggestions").empty();
                 if (report.suggestions && report.suggestions.length > 0) {
                     report.suggestions.forEach(s => {
                         $("#dba-suggestions").append($("<li>").text(s));
                     });
                 } else {
                     $("#dba-suggestions").append("<li>No suggestions.</li>");
                 }

                 // Plan
                 $("#dba-plan").text(report.planContent || "No plan content.");

                 // Metrics (Table)
                 let metricsHtml = "";
                 if (report.executionTimeMs > 0) {
                     metricsHtml += "<table border='1' style='width: 100%; border-collapse: collapse; margin-bottom: 10px;'>";
                     metricsHtml += "<tr><th style='background-color: #f2f2f2; width: 200px;'>Metric</th><th>Value</th></tr>";
                     metricsHtml += `<tr><td>Estimated Execution Time</td><td>${report.executionTimeMs} ms</td></tr>`;
                     metricsHtml += "</table>";
                 }
                 $("#dba-metrics").html(metricsHtml);
            },
            error: function(xhr) {
                $("#dba-loading").hide();
                let msg = "Unknown error";
                try {
                    // Try to parse JSON error from Spring Boot
                    let errJson = JSON.parse(xhr.responseText);
                    msg = errJson.message || errJson.error || xhr.statusText;
                } catch (e) {
                    msg = xhr.responseText || xhr.statusText;
                }
                $("#dba-error").text("ğŸ¦ Analyze Error: " + msg).show();
            }
        });
    }

    function copyPlan() {
        let planText = $("#dba-plan").text();
        navigator.clipboard.writeText(planText).then(function() {
            alert("Plan copied to clipboard!");
        }, function(err) {
            console.error('Async: Could not copy text: ', err);
            alert("Failed to copy plan.");
        });
    }

    function approveTask(taskId) {
        $.ajax({
            type: "POST",
            url: "/api/approve",
            data: { taskId: taskId },
            dataType: "json", // é—œéµ 1: å¼·åˆ¶å‘Šè¨´ jQuery é€™æ˜¯ JSONï¼Œä¸è¦ç•¶å­—ä¸²
            success: function(res) {
                console.log("Server Response:", res); // é—œéµ 2: åœ¨ F12 Console å°å‡ºçµæœæ–¹ä¾¿é™¤éŒ¯

                if (res && res.message) {
                    alert(res.message);
                } else {
                    // å¦‚æœ res æ˜¯ç‰©ä»¶ä½†æ²’ messageï¼Œæˆ–æ˜¯å…¶ä»–æ€ªæ€ªçš„ç‹€æ³
                    alert("åŸ·è¡Œå®Œæˆï¼Œä½†ç„¡å›å‚³è¨Šæ¯ã€‚\nè©³ç´°: " + JSON.stringify(res));
                }
                location.reload();
            },
            error: function(xhr, status, error) {
                // é—œéµ 3: å¦‚æœå¾Œç«¯ç‚¸æ‰ (500) æˆ–æ¬Šé™ä¸è¶³ (403)ï¼Œæœƒèµ°é€™è£¡
                console.error("Error:", xhr);
                alert("ç™¼ç”ŸéŒ¯èª¤ (Status: " + xhr.status + ")\n" + xhr.responseText);
            }
        });
    }

    function renderResult(res) {
        let color = res.status === 'SUCCESS' ? 'green' : (res.status === 'PENDING' ? 'orange' : 'red');
        $("#msgArea").html(`<b style='color:${color}'>[${res.status}] ${res.message}</b>`);
        $("#resultTable").empty();

        if (res.txStatus) {
            $("#txStatus").text(res.txStatus);
            if (res.txStatus === 'UNCOMMIT') {
                $("#txStatus").css('color', 'red');
            } else {
                $("#txStatus").css('color', 'blue');
            }
        }

        if (res.columns && res.columns.length > 0) {
            let html = "<table border='1'><thead><tr>";
            res.columns.forEach(col => html += `<th>${col}</th>`);
            html += "</tr></thead><tbody>";
            res.rows.forEach(row => {
                html += "<tr>";
                res.columns.forEach(col => html += `<td>${row[col]}</td>`);
                html += "</tr>";
            });
            html += "</tbody></table>";
            $("#resultTable").html(html);
        }
    }
</script>
</body>
</html>